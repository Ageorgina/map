import { Component, OnInit } from '@angular/core';
import * as Highcharts from 'highcharts/highmaps';
import { EstadosService } from '../../general/services/estados.service';
import { ActivatedRoute } from '@angular/router';
declare var require: any;
const Boost = require('highcharts/modules/boost');
const noData = require('highcharts/modules/no-data-to-display');
const More = require('highcharts/highcharts-more');
Boost(Highcharts);
noData(Highcharts);
More(Highcharts);
noData(Highcharts);
var $;
const data = [
  ["1191",1191],
  ["1316",1316],
  ["1186",1186],
  ["1178",1178],
  ["1181",1181],
  ["1187",1187],
  ["1311",1311],
  ["1182",1182],
  ["1202",1202],
  ["1175",1175],
  ["1201",1201],
  ["1192",1192],
  ["1312",1312],
  ["1315",1315],
  ["1317",1317],
  ["1185",1185],
  ["1465",1465],
  ["1463",1463],
  ["1467",1467],
  ["1176",1176],
  ["1459",1459],
  ["1460",1460],
  ["1464",1464],
  ["1173",1173],
  ["1179",1179],
  ["1462",1462],
  ["1172",1172],
  ["1313",1313],
  ["1174",1174],
  ["1183",1183],
  ["1177",1177],
  ["1180",1180],
  ["1461",1461],
  ["1466",1466],
  ["1184",1184],
  ["1310",1310],
  ["1314",1314],
  ["1288",1288],
  ["1289",1289],
  ["1281",1281],
  ["1305",1305],
  ["1284",1284],
  ["1290",1290],
  ["1293",1293],
  ["1244",1244],
  ["1226",1226],
  ["1396",1396],
  ["1280",1280],
  ["1335",1335],
  ["1297",1297],
  ["1286",1286],
  ["1304",1304],
  ["1282",1282],
  ["1268",1268],
  ["1238",1238],
  ["1237",1237],
  ["1303",1303],
  ["1251",1251],
  ["1256",1256],
  ["1292",1292],
  ["1370",1370],
  ["1211",1211],
  ["1255",1255],
  ["1241",1241],
  ["1217",1217],
  ["1296",1296],
  ["1235",1235],
  ["1243",1243],
  ["1231",1231],
  ["1371",1371],
  ["1394",1394],
  ["1279",1279],
  ["1301",1301],
  ["1239",1239],
  ["1236",1236],
  ["1295",1295],
  ["1246",1246],
  ["1299",1299],
  ["1252",1252],
  ["1302",1302],
  ["1234",1234],
  ["1225",1225],
  ["1308",1308],
  ["1265",1265],
  ["1291",1291],
  ["1372",1372],
  ["1245",1245],
  ["1298",1298],
  ["1262",1262],
  ["1307",1307],
  ["1306",1306],
  ["1249",1249],
  ["1300",1300],
  ["1285",1285],
  ["1263",1263],
  ["1240",1240],
  ["1334",1334],
  ["1269",1269],
  ["1229",1229],
  ["1216",1216],
  ["1274",1274],
  ["1212",1212],
  ["1250",1250],
  ["1230",1230],
  ["1278",1278],
  ["1223",1223],
  ["1294",1294],
  ["1273",1273],
  ["1242",1242],
  ["1375",1375],
  ["1253",1253],
  ["1287",1287],
  ["1369",1369],
  ["1373",1373],
  ["1270",1270],
  ["1333",1333],
  ["1219",1219],
  ["1378",1378],
  ["1376",1376],
  ["1272",1272],
  ["1221",1221],
  ["1283",1283],
  ["1337",1337],
  ["1220",1220],
  ["1247",1247],
  ["1222",1222],
  ["1224",1224],
  ["1275",1275],
  ["1198",1198],
  ["1233",1233],
  ["1344",1344],
  ["1232",1232],
  ["1254",1254],
  ["1331",1331],
  ["1228",1228],
  ["1199",1199],
  ["1259",1259],
  ["1277",1277],
  ["1203",1203],
  ["1205",1205],
  ["1188",1188],
  ["1204",1204],
  ["1208",1208],
  ["1374",1374],
  ["1380",1380],
  ["1330",1330],
  ["1377",1377],
  ["1227",1227],
  ["1325",1325],
  ["1328",1328],
  ["1189",1189],
  ["1340",1340],
  ["1196",1196],
  ["1339",1339],
  ["1267",1267],
  ["1341",1341],
  ["1194",1194],
  ["1206",1206],
  ["1248",1248],
  ["1327",1327],
  ["1326",1326],
  ["1257",1257],
  ["1190",1190],
  ["1195",1195],
  ["1264",1264],
  ["1338",1338],
  ["1336",1336],
  ["1368",1368],
  ["1215",1215],
  ["1342",1342],
  ["1207",1207],
  ["1276",1276],
  ["1197",1197],
  ["1271",1271],
  ["1332",1332],
  ["1213",1213],
  ["1200",1200],
  ["1218",1218],
  ["1258",1258],
  ["1209",1209],
  ["1309",1309],
  ["1346",1346],
  ["1214",1214],
  ["1345",1345],
  ["1367",1367],
  ["1210",1210],
  ["1329",1329],
  ["1343",1343],
  ["1261",1261],
  ["1266",1266],
  ["1193",1193],
  ["1260",1260],
  ["1436",1436],
  ["1457",1457],
  ["1608",1608],
  ["1601",1601],
  ["1594",1594],
  ["1609",1609],
  ["1607",1607],
  ["1580",1580],
  ["1600",1600],
  ["1539",1539],
  ["1437",1437],
  ["1610",1610],
  ["1571",1571],
  ["1582",1582],
  ["1606",1606],
  ["1596",1596],
  ["1603",1603],
  ["1589",1589],
  ["1599",1599],
  ["1602",1602],
  ["1588",1588],
  ["1605",1605],
  ["1458",1458],
  ["1585",1585],
  ["1544",1544],
  ["1575",1575],
  ["1604",1604],
  ["1590",1590],
  ["1592",1592],
  ["1595",1595],
  ["1574",1574],
  ["1587",1587],
  ["1597",1597],
  ["1524",1524],
  ["1573",1573],
  ["1591",1591],
  ["1522",1522],
  ["1576",1576],
  ["1578",1578],
  ["1572",1572],
  ["1581",1581],
  ["1521",1521],
  ["1584",1584],
  ["1586",1586],
  ["1379",1379],
  ["1542",1542],
  ["1579",1579],
  ["1541",1541],
  ["1593",1593],
  ["1441",1441],
  ["1545",1545],
  ["1443",1443],
  ["1598",1598],
  ["1435",1435],
  ["1439",1439],
  ["1440",1440],
  ["1577",1577],
  ["1527",1527],
  ["1525",1525],
  ["1421",1421],
  ["1438",1438],
  ["1536",1536],
  ["1543",1543],
  ["1400",1400],
  ["1404",1404],
  ["1534",1534],
  ["1381",1381],
  ["1532",1532],
  ["1528",1528],
  ["1533",1533],
  ["1424",1424],
  ["1531",1531],
  ["1416",1416],
  ["1450",1450],
  ["1401",1401],
  ["1417",1417],
  ["1523",1523],
  ["1419",1419],
  ["1422",1422],
  ["1448",1448],
  ["1452",1452],
  ["1434",1434],
  ["1537",1537],
  ["1538",1538],
  ["1583",1583],
  ["1415",1415],
  ["1431",1431],
  ["1453",1453],
  ["1535",1535],
  ["1397",1397],
  ["1413",1413],
  ["1399",1399],
  ["1454",1454],
  ["1392",1392],
  ["1444",1444],
  ["1468",1468],
  ["1530",1530],
  ["1395",1395],
  ["1418",1418],
  ["1547",1547],
  ["1402",1402],
  ["1526",1526],
  ["1420",1420],
  ["1426",1426],
  ["1428",1428],
  ["1455",1455],
  ["1432",1432],
  ["1408",1408],
  ["1433",1433],
  ["1447",1447],
  ["1423",1423],
  ["1529",1529],
  ["1427",1427],
  ["1425",1425],
  ["1540",1540],
  ["1429",1429],
  ["1398",1398],
  ["1393",1393],
  ["1405",1405],
  ["1414",1414],
  ["1442",1442],
  ["1451",1451],
  ["1406",1406],
  ["1391",1391],
  ["1403",1403],
  ["1412",1412],
  ["1430",1430],
  ["1410",1410],
  ["1446",1446],
  ["1449",1449],
  ["1546",1546],
  ["1407",1407],
  ["1445",1445],
  ["1456",1456],
  ["732",732],
  ["735",735],
  ["739",739],
  ["742",742],
  ["764",764],
  ["741",741],
  ["749",749],
  ["733",733],
  ["740",740],
  ["760",760],
  ["761",761],
  ["775",775],
  ["779",779],
  ["774",774],
  ["773",773],
  ["750",750],
  ["763",763],
  ["778",778],
  ["805",805],
  ["804",804],
  ["803",803],
  ["802",802],
  ["776",776],
  ["757",757],
  ["758",758],
  ["829",829],
  ["831",831],
  ["868",868],
  ["869",869],
  ["756",756],
  ["753",753],
  ["755",755],
  ["751",751],
  ["780",780],
  ["734",734],
  ["762",762],
  ["752",752],
  ["759",759],
  ["754",754],
  ["777",777],
  ["772",772],
  ["1614",1614],
  ["1613",1613],
  ["1612",1612],
  ["1611",1611],
  ["1616",1616],
  ["1615",1615],
  ["1617",1617],
  ["1620",1620],
  ["1619",1619],
  ["1621",1621],
  ["1631",1631],
  ["1629",1629],
  ["1623",1623],
  ["1627",1627],
  ["1630",1630],
  ["1635",1635],
  ["1634",1634],
  ["1633",1633],
  ["1636",1636],
  ["1638",1638],
  ["1637",1637],
  ["1639",1639],
  ["1641",1641],
  ["1625",1625],
  ["1640",1640],
  ["1622",1622],
  ["1624",1624],
  ["1628",1628],
  ["1626",1626],
  ["1632",1632],
  ["1618",1618],
  ["730",730],
  ["801",801],
  ["800",800],
  ["731",731],
  ["900",900],
  ["901",901],
  ["806",806],
  ["842",842],
  ["841",841],
  ["874",874],
  ["843",843],
  ["809",809],
  ["875",875],
  ["799",799],
  ["810",810],
  ["784",784],
  ["861",861],
  ["840",840],
  ["860",860],
  ["839",839],
  ["798",798],
  ["782",782],
  ["808",808],
  ["898",898],
  ["899",899],
  ["939",939],
  ["947",947],
  ["862",862],
  ["960",960],
  ["896",896],
  ["948",948],
  ["828",828],
  ["940",940],
  ["870",870],
  ["934",934],
  ["910",910],
  ["915",915],
  ["935",935],
  ["944",944],
  ["876",876],
  ["783",783],
  ["837",837],
  ["955",955],
  ["807",807],
  ["864",864],
  ["873",873],
  ["871",871],
  ["781",781],
  ["958",958],
  ["911",911],
  ["835",835],
  ["863",863],
  ["912",912],
  ["865",865],
  ["838",838],
  ["914",914],
  ["913",913],
  ["959",959],
  ["945",945],
  ["941",941],
  ["957",957],
  ["866",866],
  ["953",953],
  ["954",954],
  ["942",942],
  ["956",956],
  ["897",897],
  ["951",951],
  ["902",902],
  ["872",872],
  ["937",937],
  ["978",978],
  ["833",833],
  ["903",903],
  ["867",867],
  ["938",938],
  ["836",836],
  ["904",904],
  ["936",936],
  ["906",906],
  ["909",909],
  ["979",979],
  ["908",908],
  ["832",832],
  ["834",834],
  ["952",952],
  ["950",950],
  ["946",946],
  ["949",949],
  ["905",905],
  ["943",943],
  ["907",907]
  ];

@Component({
  selector: 'app-mapa-secciones',
  templateUrl: './mapa-secciones.component.html',
  styleUrls: ['./mapa-secciones.component.scss']
})
export class MapaSeccionesComponent implements OnInit {
  datosSecciones = [];
  headers = [];
  secciones = [];
  datosSeccion: any;
  coloresHxd = [];
  seccionID: any;
  selectedSeccion: any;
  temas: any;
  selectedId: any;
  emociones: any;
  mujeres: any;
  hombres: any;
  impactos: any;
  id: any;
  idCVS: any;

  constructor(private estado: EstadosService, private route: ActivatedRoute) {
    this.id = this.route.snapshot.paramMap.get('id');
    this.estado.getSecciones(this.id).subscribe(cvsInfo => this.construirMapa(cvsInfo));
   }
   mapa: any = {
     chart: {
       backgroundColor: '#3F3F3F'
      },
      title: { text: '' },
      mapNavigation: { enabled: true
      },
      colorAxis: {
        tickPixelInterval: 100,
        showInLegend: false,
        dataClasses: this.infoSecciones()
      },
      series: [{
        data: data,
        keys: ['seccion', 'value'],
        joinBy: 'seccion',
        dataLabels: {
          enabled: true,
          format: '{point.properties.seccion}'
        }
      }]
    };

   ngOnInit() {

    }

   construirMapa(seccionesJSON) {
    this.mapa.chart.map = seccionesJSON;

    Highcharts.mapChart('secciones', this.mapa);

  }

  infoSecciones() {
    this.estado.getCSV(this.route.snapshot.paramMap.get('id')).subscribe(info => {
      const match = info.match(/\n+[0-9]{1,4}/g);
      for (let i = 0; i < match.length; i++) {
        info = info.replace(match[i], '|' + match[i].substring(1, match[i].length));
      }
      this.datosSecciones = info.split('|');
      this.headers = this.datosSecciones[0].split(',');
      this.generarColores(info.split('|')).finally(() => {
        this.mapa.colorAxis.dataClasses = this.coloresHxd;
      });
    });
  }

   async generarColores(datosSecciones) {
     for (let i = 1; i < datosSecciones.length; i++) {
      const datos = datosSecciones[i].split(',');
      const selectColor = {
            color: this.cambiarColor(datos[1]),
            from: datos[0],
            to: datos[0]
        };
      this.coloresHxd.push(selectColor);
    }
  }

  cambiarColor(color) {
    switch (color) {
      case 'Naranja': return '#ed6706';
      case 'Rojo': return '#d01f08';
      case 'Amarillo': return '#fabc07';
      default: return '#ffffff';
    }
  }

  seccionClicked(click) {
    const lineBreak = '\n';
    this.seccionID = click;
    if(this.seccionID === null){
      return;
    }
    for (let i = 1; i < this.datosSecciones.length; i++) {
      const datos = this.datosSecciones[i].split(',');
      if (datos[0].includes(this.seccionID.toString())){
        this.selectedSeccion = datos;
        this.seccionID= this.seccionID;
        this.temas = datos[2].replace(/[/]/g, lineBreak);
        this.emociones = datos[3].replace(/'<br>', '[/]'/g, lineBreak);
        this.mujeres = datos[4].replace(/[<br/>, <br>, /]/g, lineBreak);
        this.hombres = datos[5].replace(/[<br/>, <br>, /]/g, lineBreak);
        this.impactos = datos[6].replace(/[/]/g, lineBreak) + lineBreak + datos[7];
        // this.mujeres.split('<br/>');

      }
    }


  }

}
